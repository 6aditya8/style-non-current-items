<?xml version="1.0"?>
<project name="Test Import Package" default="build" basedir=".">

	<description>Test packages by exporting and then importing into a different instance.</description>
	<property name="debug" value="true" overwrite="false" />

	<xmlpeek property="long" file=".\thisPackage.xml" xpath="/package/longname" />
	<xmlpeek property="short" file=".\thisPackage.xml" xpath="/package/name" />
	<property name="path" value="${short}\Import" overwrite="false" />

	<target name="clean" description="remove all generated files">
		<delete dir=".\log" failonerror="false" />
		<delete dir=".\package" failonerror="false" />

		<mkdir dir="log" />
		<mkdir dir="package" />

		<copy file=".\consoleUpgrade\imports.mf" tofile=".\package\imports.mf" />

		<call target="clean_dev" />
		<call target="clean_open" />
	</target>

	<target name="clean_dev" description="remove all generated files">
		<property name="configpath" value=".\testImportPackage.xml" />
		<property name="root" value="/testImportPackage/db" />

		<xmlpeek property="SqlName" file="${configpath}" xpath="${root}/sql" />
		<xmlpeek property="DB" file="${configpath}" xpath="${root}/name" />
		<xmlpeek property="BackupFilePath" file="${configpath}" xpath="${root}/path" />
		<xmlpeek property="BackupFileName" file="${configpath}" xpath="${root}/name" />
		<xmlpeek property="DB.Dir" file="${configpath}" xpath="${root}/dir" />

		<xmlpeek property="PS" file="${configpath}" xpath="/testImportPackage/versions/dev" />

		<property name="DB" value="${DB}${PS}" />
		<property name="BackupFilePath" value="${BackupFilePath}${PS}.bak" />
		<property name="BackupFileName" value="${BackupFileName}${PS}" />

		<property name="N" value="not"/>
		<property name="R" value="RESTORE"/>
		<property name="Q" value="'"/>

		<exec program="sqlcmd" output=".\log\cleanDB.log" commandline='-S ${SqlName} -E -e -Q "use [master]; if db_id(${Q}${DB}${Q}) is ${N} null BEGIN EXEC msdb.dbo.sp_delete_database_backuphistory @database_name = ${Q}${DB}${Q}; ALTER DATABASE [${DB}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE; DROP DATABASE [${DB}]; END; ${R} DATABASE [${DB}] FROM DISK = ${Q}${BackupFilePath}${Q} WITH FILE = 1, MOVE ${Q}${BackupFileName}${Q} TO ${Q}${DB.Dir}\${DB}.mdf${Q}, MOVE ${Q}${BackupFileName}_log${Q} TO ${Q}${DB.Dir}\${DB}_log.ldf${Q}, NOUNLOAD, STATS = 5; DECLARE @sql NVARCHAR(200); SET @sql=${Q}USE [${DB}]; EXEC sp_change_users_login [Auto_Fix],[innovator]${Q}; EXEC sp_executesql @sql;"' failonerror="true" />
	</target>

	<target name="clean_open" description="remove all generated files">
		<property name="configpath" value=".\testImportPackage.xml" />
		<property name="root" value="/testImportPackage/db" />

		<xmlpeek property="SqlName" file="${configpath}" xpath="${root}/sql" />
		<xmlpeek property="DB" file="${configpath}" xpath="${root}/name" />
		<xmlpeek property="BackupFilePath" file="${configpath}" xpath="${root}/path" />
		<xmlpeek property="BackupFileName" file="${configpath}" xpath="${root}/name" />
		<xmlpeek property="DB.Dir" file="${configpath}" xpath="${root}/dir" />

		<xmlpeek property="PS" file="${configpath}" xpath="/testImportPackage/versions/open" />

		<property name="DB" value="${DB}${PS}" />
		<property name="BackupFilePath" value="${BackupFilePath}${PS}.bak" />
		<property name="BackupFileName" value="${BackupFileName}${PS}" />

		<property name="N" value="not"/>
		<property name="R" value="RESTORE"/>
		<property name="Q" value="'"/>

		<exec program="sqlcmd" output=".\log\cleanDB.log" commandline='-S ${SqlName} -E -e -Q "use [master]; if db_id(${Q}${DB}${Q}) is ${N} null BEGIN EXEC msdb.dbo.sp_delete_database_backuphistory @database_name = ${Q}${DB}${Q}; ALTER DATABASE [${DB}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE; DROP DATABASE [${DB}]; END; ${R} DATABASE [${DB}] FROM DISK = ${Q}${BackupFilePath}${Q} WITH FILE = 1, MOVE ${Q}${BackupFileName}${Q} TO ${Q}${DB.Dir}\${DB}.mdf${Q}, MOVE ${Q}${BackupFileName}_log${Q} TO ${Q}${DB.Dir}\${DB}_log.ldf${Q}, NOUNLOAD, STATS = 5; DECLARE @sql NVARCHAR(200); SET @sql=${Q}USE [${DB}]; EXEC sp_change_users_login [Auto_Fix],[innovator]${Q}; EXEC sp_executesql @sql;"' failonerror="true" />
	</target>

	<target name="export" description="exports the package from the development instance">
		<property name="configpath" value=".\testImportPackage.xml" />
		<property name="root" value="/testImportPackage/export" />

		<xmlpeek property="server" file="${configpath}" xpath="${root}/server" />
		<xmlpeek property="database" file="${configpath}" xpath="${root}/database" />
		<xmlpeek property="login" file="${configpath}" xpath="${root}/login" />
		<xmlpeek property="password" file="${configpath}" xpath="${root}/password" />
		<xmlpeek property="mfFile" file="${configpath}" xpath="${root}/mfFile" />
		<xmlpeek property="dir" file="${configpath}" xpath="${root}/dir" />
		<xmlpeek property="log" file="${configpath}" xpath="${root}/log" />

		<exec program=".\consoleUpgrade\consoleUpgrade.exe" commandline="server=${server} database=${database} login=${login} password=${password} mfFile=${mfFile} verbose dir=${dir} log=${log}" failonerror="true" output=".\log\testImportPackage.log" />

		<mkdir dir="package\${short}\Import\Fixes" />
		<copy todir="package\${short}\Import\Fixes">
			<fileset basedir="fixes">
				<include name="*.xml" />
			</fileset>
		</copy>
	</target>

	<target name="import" description="imports the package into a test instance">
		<call target="import_dev" />
		<call target="import_open" />
	</target>

	<target name="import_dev" description="imports the package into a test instance">
		<property name="configpath" value=".\testImportPackage.xml" />
		<property name="root" value="/testImportPackage/import" />

		<xmlpeek property="server" file="${configpath}" xpath="${root}/server" />
		<xmlpeek property="database" file="${configpath}" xpath="${root}/database" />
		<xmlpeek property="login" file="${configpath}" xpath="${root}/login" />
		<xmlpeek property="password" file="${configpath}" xpath="${root}/password" />
		<xmlpeek property="mfFile" file="${configpath}" xpath="${root}/mfFile" />
		<xmlpeek property="dir" file="${configpath}" xpath="${root}/dir" />
		<xmlpeek property="log" file="${configpath}" xpath="${root}/log" />

		<xmlpeek property="PS" file="${configpath}" xpath="/testImportPackage/versions/dev" />

		<property name="server" value="${server}${PS}" />
		<property name="database" value="${database}${PS}" />
		<property name="log" value="${log}To${database}.log" />

		<exec program=".\consoleUpgrade\consoleUpgrade.exe" commandline="server=${server} database=${database} login=${login} password=${password} release=${short} mfFile=${mfFile} import merge verbose dir=${dir} log=${log}" failonerror="true" output=".\log\testImportPackage.log" />

		<property name="IE" value="C:\Program Files\Internet Explorer\iexplore.exe" />
		<exec program="${IE}" commandline="${server}" failonerror="false" />
	</target>

	<target name="import_open" description="imports the package into a test instance">
		<property name="configpath" value=".\testImportPackage.xml" />
		<property name="root" value="/testImportPackage/import" />

		<xmlpeek property="server" file="${configpath}" xpath="${root}/server" />
		<xmlpeek property="database" file="${configpath}" xpath="${root}/database" />
		<xmlpeek property="login" file="${configpath}" xpath="${root}/login" />
		<xmlpeek property="password" file="${configpath}" xpath="${root}/password" />
		<xmlpeek property="mfFile" file="${configpath}" xpath="${root}/mfFile" />
		<xmlpeek property="dir" file="${configpath}" xpath="${root}/dir" />
		<xmlpeek property="log" file="${configpath}" xpath="${root}/log" />

		<xmlpeek property="PS" file="${configpath}" xpath="/testImportPackage/versions/open" />

		<property name="server" value="${server}${PS}" />
		<property name="database" value="${database}${PS}" />
		<property name="log" value="${log}To${database}.log" />

		<exec program=".\consoleUpgrade\consoleUpgrade.exe" commandline="server=${server} database=${database} login=${login} password=${password} release=${short} mfFile=${mfFile} import merge verbose dir=${dir} log=${log}" failonerror="true" output=".\log\testImportPackage.log" />

		<property name="IE" value="C:\Program Files\Internet Explorer\iexplore.exe" />
		<exec program="${IE}" commandline="${server}" failonerror="false"/>
	</target>

	<target name="verified" description="copies the package to project root once tested">
		<delete dir="..\Import" failonerror="false" />
		<mkdir dir="..\Import" />
		<copy todir="..\Import">
			<fileset basedir="package">
				<include name="imports.mf" />
			</fileset>
		</copy>
		<mkdir dir="..\Import\${short}" />
		<copy todir="..\Import\${short}">
			<fileset basedir="package\${short}"/>
		</copy>
	</target>
</project>
